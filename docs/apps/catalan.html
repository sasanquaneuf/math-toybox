<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Catalan Correspondence Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }
        
        /* スクロールバーのカスタマイズ */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .pattern-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid #e2e8f0;
            position: relative;
        }
        .pattern-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 20px -5px rgba(0, 0, 0, 0.1);
            border-color: #6366f1;
            z-index: 10;
        }

        .view-btn.active {
            background-color: #4f46e5;
            color: white;
        }

        .density-btn.active {
            background-color: #334155;
            color: white;
        }

        .math-font { font-family: 'JetBrains Mono', monospace; }

        html, body { height: 100%; overflow: hidden; }

        /* グリッド密度の動的制御 */
        #patterns-container.density-detail { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
        #patterns-container.density-normal { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
        #patterns-container.density-compact { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
        
        #patterns-container.density-compact .pattern-card { padding: 0.5rem; min-height: 110px; border-radius: 0.5rem; }
        #patterns-container.density-normal .pattern-card { padding: 1rem; min-height: 180px; }
        #patterns-container.density-detail .pattern-card { padding: 2rem; min-height: 280px; }

        /* タブのスクロールバー非表示 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex flex-col w-full h-full">

    <!-- ヘッダー -->
    <header class="flex-none w-full bg-white border-b border-slate-200 px-6 py-3 z-20 shadow-sm">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-indigo-600 rounded-lg text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-slate-900 leading-tight">Catalan Multiverse</h1>
                    <p id="view-desc" class="text-[10px] text-slate-400 font-bold uppercase tracking-widest leading-none mt-1">格子道</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- n 操作ボタン -->
                <div class="flex items-center gap-2 bg-slate-100 p-1 rounded-xl border border-slate-200">
                    <button id="btn-minus" class="w-8 h-8 flex items-center justify-center rounded-lg bg-white shadow-sm text-slate-600 hover:bg-slate-50 disabled:opacity-30 transition-all">-</button>
                    <div class="flex flex-col items-center px-2 min-w-[3rem]">
                        <span class="text-[8px] font-bold text-slate-400">INDEX N</span>
                        <span id="val-n" class="text-lg font-bold text-slate-800 leading-none">3</span>
                    </div>
                    <button id="btn-plus" class="w-8 h-8 flex items-center justify-center rounded-lg bg-white shadow-sm text-slate-600 hover:bg-slate-50 disabled:opacity-30 transition-all">+</button>
                </div>
                <!-- カタラン数表示 -->
                <div class="flex flex-col items-end border-l border-slate-200 pl-4">
                    <span class="text-[8px] font-bold text-indigo-400 uppercase tracking-widest">Patterns</span>
                    <span id="catalan-count" class="text-xl font-mono font-black text-indigo-600 leading-none">5</span>
                </div>
            </div>
        </div>
    </header>

    <!-- コントロールバー（モード切替と密度調整） -->
    <div class="flex-none bg-white border-b border-slate-100 p-2 z-10 overflow-x-auto no-scrollbar">
        <div class="max-w-7xl mx-auto flex flex-col sm:flex-row items-center justify-center gap-4">
            <!-- ビジュアライズモード選択 -->
            <div class="flex bg-slate-100 p-1 rounded-xl shadow-inner">
                <button onclick="setView('path')" id="btn-path" class="view-btn active px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-slate-500 hover:text-indigo-600">格子道</button>
                <button onclick="setView('mountain')" id="btn-mountain" class="view-btn px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-slate-500 hover:text-indigo-600">折れ線</button>
                <button onclick="setView('parens')" id="btn-parens" class="view-btn px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-slate-500 hover:text-indigo-600">カッコ</button>
                <button onclick="setView('tableau')" id="btn-tableau" class="view-btn px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-slate-500 hover:text-indigo-600">標準盤</button>
            </div>
            <!-- グリッド表示密度選択 -->
            <div class="flex items-center gap-2">
                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">表示密度:</span>
                <div class="flex bg-slate-100 p-1 rounded-xl shadow-inner">
                    <button onclick="setDensity('detail')" id="den-detail" class="density-btn px-3 py-1 rounded-lg text-[10px] font-bold text-slate-500">詳細</button>
                    <button onclick="setDensity('normal')" id="den-normal" class="density-btn active px-3 py-1 rounded-lg text-[10px] font-bold text-slate-500">標準</button>
                    <button onclick="setDensity('compact')" id="den-compact" class="density-btn px-3 py-1 rounded-lg text-[10px] font-bold text-slate-500">一覧</button>
                </div>
            </div>
        </div>
    </div>

    <!-- カード一覧エリア -->
    <main class="flex-1 overflow-y-auto custom-scroll p-4 md:p-8">
        <div id="patterns-container" class="max-w-7xl mx-auto grid density-normal gap-4">
            <!-- JavaScriptによってパターンカードが動的に挿入されます -->
        </div>
    </main>

    <script>
        let n = 3;
        let viewMode = 'path';
        let density = 'normal';
        const maxN = 7;
        const minN = 0;

        const descs = {
            path: "格子道：n×nのマス目を通る最短経路 (1=上, 0=右)",
            mountain: "折れ線：上昇と下降による表現 (1=／, 0=＼)",
            parens: "カッコの対応：正しく閉じられた文字列 (1=(, 0=))",
            tableau: "標準盤：2×nの盤面、各行・列が昇順になるように数字を配置"
        };

        function init() {
            document.getElementById('btn-plus').addEventListener('click', () => changeN(1));
            document.getElementById('btn-minus').addEventListener('click', () => changeN(-1));
            update();
        }

        function changeN(delta) {
            const next = n + delta;
            if (next >= minN && next <= maxN) {
                n = next;
                update();
            }
        }

        function setView(mode) {
            viewMode = mode;
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${mode}`).classList.add('active');
            document.getElementById('view-desc').textContent = descs[mode];
            render();
        }

        function setDensity(d) {
            density = d;
            document.querySelectorAll('.density-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`den-${d}`).classList.add('active');
            const container = document.getElementById('patterns-container');
            container.classList.remove('density-detail', 'density-normal', 'density-compact');
            container.classList.add(`density-${d}`);
            render();
        }

        let cacheData = [];
        function update() {
            document.getElementById('val-n').textContent = n;
            document.getElementById('btn-plus').disabled = (n >= maxN);
            document.getElementById('btn-minus').disabled = (n <= minN);
            cacheData = generate(n);
            document.getElementById('catalan-count').textContent = cacheData.length;
            render();
        }

        // カタラン数の生成 (1=Up, 0=Right)
        function generate(n) {
            if (n === 0) return [[]];
            const res = [];
            const backtrack = (p, o, c) => {
                if (p.length === 2 * n) { res.push([...p]); return; }
                if (o < n) { p.push(1); backtrack(p, o + 1, c); p.pop(); }
                if (c < o) { p.push(0); backtrack(p, o, c + 1); p.pop(); }
            };
            backtrack([], 0, 0);
            return res;
        }

        function render() {
            const container = document.getElementById('patterns-container');
            container.innerHTML = '';
            const frag = document.createDocumentFragment();

            cacheData.forEach((path, i) => {
                const card = document.createElement('div');
                card.className = 'pattern-card';
                
                if (viewMode === 'path') drawPath(card, path);
                else if (viewMode === 'mountain') drawMountain(card, path);
                else if (viewMode === 'parens') drawParens(card, path);
                else if (viewMode === 'tableau') drawTableau(card, path);

                // インデックスラベルの追加
                if (density !== 'compact') {
                    const idx = document.createElement('div');
                    idx.className = 'absolute bottom-2 right-3 text-[8px] font-black text-slate-300 math-font';
                    idx.textContent = `#${(i+1).toString().padStart(3, '0')}`;
                    card.appendChild(idx);
                }

                frag.appendChild(card);
            });
            container.appendChild(frag);
        }

        // --- ビジュアライザー描画ロジック ---

        // 1. 格子道 (塗りつぶし形式)
        function drawPath(card, path) {
            const grid = document.createElement('div');
            grid.className = 'grid gap-[1px] bg-slate-100 border border-slate-200 p-[1px] rounded-sm';
            grid.style.gridTemplateColumns = `repeat(${n}, 1fr)`;
            
            const visitedCells = [];
            let cx = 0, cy = 0;
            path.forEach(s => {
                if (s === 1) { visitedCells.push({x: cx, y: cy}); cy++; }
                else { cx++; }
            });

            for (let y = n - 1; y >= 0; y--) {
                for (let x = 0; x < n; x++) {
                    const cell = document.createElement('div');
                    let size = density === 'detail' ? 'w-5 h-5' : density === 'normal' ? 'w-3 h-3' : 'w-2 h-2';
                    if (n > 5) size = density === 'detail' ? 'w-4 h-4' : 'w-2 h-2';
                    
                    cell.className = `${size} rounded-[1px]`;
                    const isPath = visitedCells.some(v => v.x === x && v.y === y);
                    if (isPath) cell.classList.add('bg-indigo-500');
                    else if (y < x) cell.classList.add('bg-slate-200', 'opacity-30');
                    else cell.classList.add('bg-white');
                    grid.appendChild(cell);
                }
            }
            card.appendChild(grid);
        }

        // 2. 折れ線
        function drawMountain(card, path) {
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            const w = 100, h = 50;
            svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
            svg.style.width = "90%";
            svg.classList.add("overflow-visible");

            let d = `M 0 ${h}`;
            let cx = 0, cy = h;
            const dx = w / (2 * n || 1);
            const dy = h / (n || 1);

            path.forEach(s => {
                cx += dx;
                cy += (s === 1 ? -dy : dy);
                d += ` L ${cx} ${cy}`;
            });

            const p = document.createElementNS(svgNS, "path");
            p.setAttribute("d", d);
            p.setAttribute("fill", "none");
            p.setAttribute("stroke", "#4f46e5");
            p.setAttribute("stroke-width", density === 'compact' ? "4" : "3");
            p.setAttribute("stroke-linecap", "round");
            p.setAttribute("stroke-linejoin", "round");

            const base = document.createElementNS(svgNS, "line");
            base.setAttribute("x1", 0); base.setAttribute("y1", h);
            base.setAttribute("x2", w); base.setAttribute("y2", h);
            base.setAttribute("stroke", "#e2e8f0");
            base.setAttribute("stroke-width", "1");

            svg.appendChild(base);
            svg.appendChild(p);
            card.appendChild(svg);
        }

        // 3. カッコ
        function drawParens(card, path) {
            const container = document.createElement('div');
            container.className = 'flex flex-wrap justify-center items-center gap-[1px] px-2 leading-none font-black math-font';
            
            let depth = 0;
            const colors = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#06b6d4'];
            
            path.forEach(s => {
                const span = document.createElement('span');
                const fs = density === 'detail' ? 'text-2xl' : density === 'normal' ? 'text-sm' : 'text-[9px]';
                span.className = fs;
                if (s === 1) {
                    span.textContent = '(';
                    span.style.color = colors[depth % colors.length];
                    depth++;
                } else {
                    depth--;
                    span.textContent = ')';
                    span.style.color = colors[depth % colors.length];
                }
                container.appendChild(span);
            });
            card.appendChild(container);
        }

        // 4. 標準盤 (Standard Young Tableau)
        function drawTableau(card, path) {
            const row1 = [], row2 = [];
            path.forEach((s, i) => {
                if (s === 1) row1.push(i + 1);
                else row2.push(i + 1);
            });

            const grid = document.createElement('div');
            grid.className = 'grid gap-1 p-1';
            grid.style.gridTemplateColumns = `repeat(${n}, 1fr)`;

            const renderRow = (data) => {
                data.forEach(v => {
                    const cell = document.createElement('div');
                    
                    // サイズとフォントサイズの動的調整
                    let size, fontSize;
                    if (density === 'detail') {
                        size = 'w-10 h-10';
                        fontSize = n > 5 ? 'text-sm' : 'text-xl';
                    } else if (density === 'normal') {
                        size = 'w-7 h-7';
                        fontSize = n > 5 ? 'text-[9px]' : 'text-xs';
                    } else { // compact
                        size = 'w-5 h-5';
                        fontSize = 'text-[7px]';
                    }

                    cell.className = `${size} ${fontSize} flex items-center justify-center font-bold math-font border border-slate-300 rounded-md text-slate-800 bg-white`;
                    cell.textContent = v;
                    grid.appendChild(cell);
                });
            };

            renderRow(row1);
            renderRow(row2);
            card.appendChild(grid);
        }

        window.onload = init;
    </script>
</body>
</html>